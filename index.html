<!DOCTYPE html>
<html>
	<head>
		<title>OvenMediaEngine client</title>
		<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
		<script src="https://unpkg.com/vue-router@4.2.4/dist/vue-router.global.js"></script>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
		<script src="https://www.unpkg.com/moment@2.30.1/moment.js"></script>
	</head>
	<body>
		<div class="container" id="app">
			<h1>OvenMediaEngine API client</h1>
			<router-view></router-view>
		</div>
		<script type="text/javascript">
function formatBytes(bytes, decimals = 2) {
    if(!+bytes) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
}

class OvenMediaEngineAPIClient {
	constructor(apiUrl, accessToken) {
		this.setApiUrl(apiUrl);
		this.setAccessToken(accessToken);
	}
	setApiUrl(url) { this.apiUrl = url; }
	setAccessToken(token) { this.accessToken = btoa(token); }
	request(method, resource, body) {
		let fetchOptions = {
			headers: { Authorization: `Basic ${this.accessToken}` },
			method,
		};
		if(method == 'POST') fetchOptions.body = JSON.stringify(body);
		const url = `${this.apiUrl}/v1/${resource}`;
		return fetch(url, fetchOptions).then(r => r.json()).then(r => {
			if(Array.isArray(body)) {
				if(r[0].statusCode != 200)
					throw new Error(`API Error ${r[0].statusCode} ${r[0].message}`);
			} else if(r.statusCode != 200)
				throw new Error(`API Error ${r.statusCode} ${r.message}`);
			return r.response;
		});
	}
	get(resource) {
		return this.request('GET', resource);
	}
	post(resource, body) {
		return this.request('POST', resource, body);
	}
};

const api = new OvenMediaEngineAPIClient();

const Statistics = {
	template: `
		<div class="float-end">
			<div class="form-check form-switch form-check-reverse">
				<input class="form-check-input" type="checkbox" id="statisticsJsonSwitch" v-model="json">
				<label class="form-check-label" for="statisticsJsonSwitch">raw</label>
			</div>
		</div>
		<h3>Statistics</h3>
		<pre v-show="json">{{data}}</pre>
		<div v-show="!json" v-if="data">
			<table class="table table-sm">
				<thead><tr><th></th><th class="text-end">IN</th><th class="text-end">OUT</th></tr></thead>
				<tbody>
					<tr><th>Average</th><td class="text-end">{{formatBytes(data.avgThroughputIn)}}/s</td><td class="text-end">{{formatBytes(data.avgThroughputOut)}}/s</td></tr>
					<tr><th>Max</th><td class="text-end">{{formatBytes(data.maxThroughputIn)}}/s</td><td class="text-end">{{formatBytes(data.maxThroughputOut)}}/s</td></tr>
					<tr><th>Last</th><td class="text-end">{{formatBytes(data.lastThroughputIn)}}/s<br/><abbr :title="data.lastRecvTime">{{fromNow(data.lastRecvTime)}}</abbr></td><td class="text-end">{{formatBytes(data.lastThroughputOut)}}/s<br/><abbr :title="data.lastSentTime">{{fromNow(data.lastSentTime)}}</abbr></td></tr>
					<tr><th rowspan="2">Total</th><td class="text-end">{{formatBytes(data.totalBytesIn)}}</td><td class="text-end">{{formatBytes(data.totalBytesOut)}}</td></tr>
					<tr><td class="text-center" colspan="2"><abbr :title="data.createdTime">Since {{fromNow(data.createdTime)}}</abbr></td></tr>
				</tbody>
			</table>
			<table class="table table-sm">
				<thead><tr><th>Connections</th><th></th></tr></thead>
				<tbody>
					<tr :class="{ 'table-success': data?.connections?.dash > 0 }"><th>DASH</th><td class="text-end">{{data?.connections?.dash}}</td></tr>
					<tr :class="{ 'table-success': data?.connections?.file > 0 }"><th>File</th><td class="text-end">{{data?.connections?.file}}</td></tr>
					<tr :class="{ 'table-success': data?.connections?.hls > 0 }"><th>HLS</th><td class="text-end">{{data?.connections?.hls}}</td></tr>
					<tr :class="{ 'table-success': data?.connections?.lldash > 0 }"><th>LLDASH</th><td class="text-end">{{data?.connections?.lldash}}</td></tr>
					<tr :class="{ 'table-success': data?.connections?.llhls > 0 }"><th>LLHLS</th><td class="text-end">{{data?.connections?.llhls}}</td></tr>
					<tr :class="{ 'table-success': data?.connections?.mpegtspush > 0 }"><th>MPEGTS Push</th><td class="text-end">{{data?.connections?.mpegtspush}}</td></tr>
					<tr :class="{ 'table-success': data?.connections?.ovt > 0 }"><th>OVT</th><td class="text-end">{{data?.connections?.ovt}}</td></tr>
					<tr :class="{ 'table-success': data?.connections?.rtmppush > 0 }"><th>RTMP Push</th><td class="text-end">{{data?.connections?.rtmppush}}</td></tr>
					<tr :class="{ 'table-success': data?.connections?.thumbnail > 0 }"><th>Thumbnail</th><td class="text-end">{{data?.connections?.thumbnail}}</td></tr>
					<tr :class="{ 'table-success': data?.connections?.webrtc > 0 }"><th>WebRTC</th><td class="text-end">{{data?.connections?.webrtc}}</td></tr>
				</tbody>
				<tfoot>
					<tr>
						<th>Total</th>
						<td class="text-end">
							{{data.totalConnections}}<br />
							<abbr :title="data.maxTotalConnectionTime">{{fromNow(data.maxTotalConnectionTime)}}</abbr>
						</td>
					</tr>
				</tfoot>
			</table>
			Last updated <abbr :title="data.lastUpdatedTime">{{fromNow(data.lastUpdatedTime)}}</abbr><br />
		</div>
	`,
	data() { return {
		json: false,
	} },
	props: {
		data: Object,
	},
	methods: {
		fromNow(d) { return d && moment(d).fromNow() || '-'; },
		formatBytes(d) { return formatBytes(d); },
	},
};

const Home = {
	template: `
		<div class="row">
			<div class="col-8">
				<div class="float-end">
					<div class="form-check form-switch form-check-reverse">
						<input class="form-check-input" type="checkbox" id="showServersJson" v-model="showServersJson">
						<label class="form-check-label" for="showServersJson">raw</label>
					</div>
				</div>
				<h3>Servers</h3>
				<pre v-show="showServersJson">{{hosts}}</pre>
				<table class="table table-striped table-sm" v-show="!showServersJson">
					<thead><tr><th>Host</th><th>URL</th><th></th></tr></thead>
					<tbody>
						<tr v-for="(host, idx) in hosts">
							<td>
								<router-link :to="'/'+encodeURIComponent(host.url)">{{host.name||host.url}}</router-link>
							</td>
							<td>
								<a :href="host.url">{{host.url}} ☍</a>
							</td>
							<td class="text-end">
								<a href="#" @click.stop.prevent="deleteHost(idx, host)" class="text-danger">Delete</a>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="col-4">
				<div class="form form-inline">
					<div class="form-group mb-3">
						<label for="apiName" class="form-label">Name</label>
						<input type="text" class="form-control" v-model="curHost.name" id="apiName">
					</div>
					<div class="form-group mb-3">
						<label for="apiUrl" class="form-label">API URL</label>
						<input type="text" class="form-control" v-model="curHost.url" id="apiUrl">
					</div>
					<div class="form-group mb-3">
						<label for="apiKey" class="form-label">API Key</label>
						<input type="text" class="form-control" v-model="curHost.token" id="apiKey">
					</div>
					<button type="button" class="btn btn-primary btn-justified" @click.prevent.stop="addHost()">Add</button>
					<p class="form-text">This data is only stored in your browser's local storage</p>
				</div>
			</div>
		</div>
	`,
	created() {
		this.loadHosts();
	},
	data() { return {
		error: null,
		showServersJson: false,
		hosts: [],
		curHost: { name: '', url: '', token: '' },
		vhosts: [],
		vhostName: 'default',
		apps: [],
	}},
	methods: {
		loadHosts() {
			try {
				this.hosts = JSON.parse(localStorage.getItem('hosts')||'[]');
			} catch(e) {
				console.error(e);
				this.error = e;
			}
		},
		saveHosts() {
			localStorage.setItem('hosts', JSON.stringify(this.hosts));
			localStorage.setItem('curHost', this.curHost);
		},
		addHost() {
			this.hosts.push({ ...this.curHost });
			this.saveHosts();
			this.curHost = { name: '', url: '', token: '' };
		},
		deleteHost(idx, host) {
			this.hosts.splice(idx, 1);
			localStorage.setItem('hosts', JSON.stringify(this.hosts));
		},
	},
};

const Server = {
	template: `
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><router-link to="/">Servers</router-link></li>
				<li class="breadcrumb-item active" aria-current="page">
					{{server?.name||server?.url||$route.params.serverUrl}}
				</li>
			</ol>
		</nav>
		<div class="row">
			<div class="col-8">
				<div class="alert alert-danger" v-if="error">{{error}}</div>
				<ul>
					<li>Name: {{server?.name}}</li>
					<li>URL: {{server?.url}}</li>
					<li><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts'">vhosts</router-link></li>
				</ul>
			</div>
			<div class="col-4" v-if="server">
				<div class="form form-inline">
					<div class="form-group mb-3">
						<label for="apiName" class="form-label">Name</label>
						<input type="text" class="form-control" v-model="server.name" id="apiName">
					</div>
					<div class="form-group mb-3">
						<label for="apiUrl" class="form-label">API URL</label>
							<input type="text" readonly disabled class="form-control" v-model="server.url" id="apiUrl">
					</div>
					<div class="form-group mb-3">
						<label for="apiKey" class="form-label">API Key</label>
						<div class="input-group">
							<input :type="showPassword ? 'text' : 'password'" class="form-control" v-model="server.token" id="apiKey">
							<button class="btn btn-outline-secondary" type="button" @click="showPassword = !showPassword">Show</button>
						</div>
					</div>
					<button type="button" class="btn btn-primary btn-justified" @click.prevent.stop="saveHost()">Save</button>
				</div>
			</div>
		</div>
	`,
	data() { return {
		server: null,
		showPassword: false,
		error: null,
	}},
	created() {
		this.loadServer();
	},
	methods: {
		async loadServer() {
			try {
				const servers = JSON.parse(localStorage.getItem('hosts')||'[]');
				this.server = servers.find(s => s.url == this.$route.params.serverUrl);
				if(!this.server) throw new Error(`Server ${this.$route.params.serverUrl} not found`);
				api.setApiUrl(this.server.url);
				api.setAccessToken(this.server.token);
			} catch(e) {
				this.error = e;
			}
		},
		saveHost() {
			try {
				const servers = JSON.parse(localStorage.getItem('hosts')||'[]');
				const idx = servers.findIndex(s => s.url == this.$route.params.serverUrl);
				if(idx < 0) throw new Error(`Server ${this.$route.params.serverUrl} not found`);
				servers[idx].name = this.server.name;
				servers[idx].token = this.server.token;
				localStorage.setItem('hosts', JSON.stringify(servers));
			} catch(e) {
				this.error = e;
			}
		},
	},
};

const VHosts = {
	template: `
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><router-link to="/">Servers</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)">{{$route.params.serverUrl}}</router-link></li>
				<li class="breadcrumb-item active" aria-current="page">
					vhosts
					<div class="spinner-border spinner-border-sm" role="status" v-if="loading">
						<span class="visually-hidden">Loading...</span>
					</div>
				</li>
			</ol>
		</nav>
		<div class="alert alert-danger" v-if="error">{{error}}</div>
		<div class="row">
			<div class="col-8">
				<table class="table table-sm table-striped">
					<thead><tr><td>VHost</td><td></td><td></td><td></td></tr></thead>
					<tbody>
						<tr v-for="(vhost,idx) in vhosts" :key="idx">
							<td><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent(vhost)">{{vhost}}</router-link></td>
							<td><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent(vhost)+'/apps'">Apps</router-link></td>
							<td><a href="#" @click.prevent="deleteVhost(vhost)" class="text-danger">Delete</a></td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="col-4">
				<form @submit.prevent="addVhost()">
					<div class="form-group">
						<label for="vhostName" class="form-label">Name</label>
						<input class="form-control" id="vhostName" v-model="vhost.name">
					</div>
					<div class="form-group">
						<div v-for="(name, idx) in vhost.host.names" class="input-group">
							<input class="form-control" :id="\`vhostHostName\${idx}\`" v-model="vhost.host.names[idx]">
							<button type="button" class="btn btn-danger" @click="vhost.host.names.splice(idx, 1)">X</button>
						</div>
					</div>
					<div class="form-group">
						<label for="vhostTlsCertPath">TLS Cert Path</label>
						<input class="form-control" id="vhostTlsCertPath" v-model="vhost.host.tls.certPath">
						<label for="vhostTlsChainCertPath">TLS Chain Cert Path</label>
						<input class="form-control" id="vhostTlsChainCertPath" v-model="vhost.host.tls.chainCertPath">
						<label for="vhostTlsKeyPath">TLS Key Path</label>
						<input class="form-control" id="vhostTlsKeyPath" v-model="vhost.host.tls.keyPath">
					</div>
					<div class="form-group mb-3">
						<label for="vhostSignedPolicyPolicyQueryKeyName" class="form-label">Signed Policy Query Key Name</label>
						<input class="form-control" id="vhostSignedPolicyPolicyQueryKeyName" v-model="vhost.signedPolicy.policyQueryKeyName">
					</div>
					<button class="btn btn-primary" type="button" @click="vhost.host.names.push('')">Add</button>
				</form>
			</div>
		</div>
	`,
	data() { return {
		loading: 0,
		vhosts: [],
		vhost: {
			host: {
				names: [],
				tls: {
					certPath: '',
					chanCertPath: '',
					keyPath: '',
				},
			},
			signedPolicy: {
				enables: {
					providers: 'rtmp,webrtc,srt',
					publishers: 'webrtc,llhls',
				},
				policyQueryKeyName: 'policy',
				secretKey: '',
				signatureQueryKeyName: '',
			},
			admissionWebhooks: {
				controlServerUrl: '',
				enables: {
					providers: 'rtmp,webrtc,srt',
					publishers: 'webrtc,llhls',
				},
				secretKey: '',
				timeout: 3000,
			},
			origins: {
				origin: [],
			},
			originMapStore: {
				originHostName: '',
				redisServer: {
					auth: '',
					host: '',
				},
			},
		},
		providers: [ 'rtmp', 'webrtc', 'srt', ],
		publishers: [ 'webrtc', 'llhls', ],
		error: null,
	}},
	async created() {
		try {
			this.loading++;
			this.error = null;
			const servers = JSON.parse(localStorage.getItem('hosts')||'[]');
			this.server = servers.find(s => s.url == this.$route.params.serverUrl);
			if(!this.server) throw new Error(`Server ${this.$route.params.serverUrl} not found`);
			api.setApiUrl(this.server.url);
			api.setAccessToken(this.server.token);
			this.vhosts = await api.get('vhosts');
		} catch(e) {
			this.error = e;
		} finally {
			this.loading--;
		}
	},
	methods: {
		deleteVhost(vhost) {
			api.request('DELETE', `vhosts/${encodeURIComponent(vhost)}`).then(() => this.loadVhosts(), err => this.error = err);
		},
	},
};
const VHost = {
	template: `
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><router-link to="/">Servers</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)">{{$route.params.serverUrl}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts'">vhosts</router-link></li>
				<li class="breadcrumb-item active" aria-current="page">
					{{$route.params.vhost}}
					<div class="spinner-border spinner-border-sm" role="status" v-if="loading">
						<span class="visually-hidden">Loading...</span>
					</div>
				</li>
			</ol>
		</nav>
		<div class="alert alert-danger" v-if="error">{{error}}</div>
		<div class="row">
			<div class="col-8">
				<ul>
					<li>Name: <span v-if="vhost">{{vhost.name}}</span><span v-else class="placeholder col-7"></span></li>
					<li>Cross domains: <code v-if="vhost" v-for="(name, idx) in vhost.crossDomains" :idx="idx">{{name}}</code><span v-else class="placeholder col-7"></span></li>
					<li v-if="vhost?.host">Host names: <code v-for="(name, idx) in vhost.host.names" :idx="idx">{{name}}</code></li>
					<li v-if="vhost?.host?.tls">TLS certificate: <code>{{vhost.host.tls.certPath}}</code></li>
					<li v-if="vhost?.host?.tls">TLS chain: <code>{{vhost.host.tls.chainCertPath}}</code></li>
					<li v-if="vhost?.host?.tls">TLS key: <code>{{vhost.host.tls.keyPath}}</code></li>
					<li v-if="vhost?.admissionWebhooks">
						Admission Webhooks
						<ul>
							<li>Control server URL: {{vhost?.admissionWebhooks?.controlServerUrl}}</li>
							<li>Secret key: ***</li>
							<li>Enables providers: {{vhost?.admissionWebhooks?.enables?.providers}}</li>
							<li>Enables publishers: {{vhost?.admissionWebhooks?.enables?.publishers}}</li>
							<li>Secret key: {{vhost?.admissionWebhooks?.secretKey}}</li>
							<li>Timeout: {{vhost?.admissionWebhooks?.timeOut}}</li>
						</ul>
					</li>
					<li>Cross-domains: <code>{{vhost?.crossDomains.join(', ')}}</code></li>
					<li>Distribution: {{vhost?.distribution}}</li>
					<li><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps'">Apps</router-link></li>
					<li><a class="text-danger" href="#" @click="deleteVhost($route.params.vhost)">Delete</a></li>
				</ul>
			</div>
			<div class="col-4">
				<statistics :data="statistics"/>
			</div>
		</div>
	`,
	data() { return {
		error: null,
		loading: 0,
		vhost: null,
		statistics: null,
	}},
	components: {
		Statistics,
	},
	created() {
		const server = JSON.parse(localStorage.getItem('hosts')||'[]').find(s => s.url == this.$route.params.serverUrl);
		api.setApiUrl(server.url);
		api.setAccessToken(server.token);
		this.loadVhost();
	},
	methods: {
		async loadVhost() {
			try {
				this.loading++;
				this.vhost = await api.get(`vhosts/${encodeURIComponent(this.$route.params.vhost)}`);
				this.statistics = await api.get(`stats/current/vhosts/${encodeURIComponent(this.$route.params.vhost)}`);
			} catch(err) {
				this.error = err;
			} finally {
				this.loading--;
			}
		},
		deleteVhost(vhost) {
			api.request('DELETE', `vhosts/${encodeURIComponent(vhost)}`).then(() => this.loadVhosts(), err => this.error = err);
		},
	},
};
const Apps = {
	template: `
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><router-link to="/">Servers</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)">{{$route.params.serverUrl}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts'">vhosts</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)">{{$route.params.vhost}}</router-link></li>
				<li class="breadcrumb-item active" aria-current="page">
					Apps
					<div class="spinner-border spinner-border-sm" role="status" v-if="loading">
						<span class="visually-hidden">Loading...</span>
					</div>
				</li>
			</ol>
		</nav>
		<div class="alert alert-danger" v-if="error">{{error}}</div>
		<table v-if="apps && apps.length > 0" class="table table-sm table-striped">
			<tbody>
				<tr v-for="(app,idx) in apps" :key="idx">
					<td><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+$route.params.vhost+'/apps/'+app">{{app}}</router-link></td>
					<td><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+$route.params.vhost+'/apps/'+app+'/outputProfiles'">Output profiles</router-link></td>
					<td><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+$route.params.vhost+'/apps/'+app+'/pushes'">Pushes</router-link></td>
					<td><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+$route.params.vhost+'/apps/'+app+'/streams'">Streams</router-link></td>
					<td class="text-end"><a href="#" @click="deleteApp($route.params.vhost, app)" class="text-danger">Delete</a></td>
				</tr>
			</tbody>
		</table>
		<div v-else>No apps</div>
	`,
	data() { return {
		error: null,
		loading: 0,
		apps: [],
	}},
	created() {
		const server = JSON.parse(localStorage.getItem('hosts')||'[]').find(s => s.url == this.$route.params.serverUrl);
		api.setApiUrl(server.url);
		api.setAccessToken(server.token);
		this.loadApps();
	},
	methods: {
		loadApps() {
			this.loading++;
			api.get(`vhosts/${encodeURIComponent(this.$route.params.vhost)}/apps`).then(apps => this.apps = apps, err => this.error = err).finally(() => this.loading--);
		},
		deleteApp(vhost, app) {
			api.request('DELETE', `vhosts/${encodeURIComponent(vhost)}/apps/${encodeURIComponent(app)}`).then(() => this.loadApps(), err => this.error = err);
		},
	},
};
const App = {
	template: `
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><router-link to="/">Servers</router-link></li>
				<li class="breadcrumb-item" aria-current="page"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)">{{$route.params.serverUrl}}</router-link></li>
				<li class="breadcrumb-item" aria-current="page"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts'">vhosts</router-link></li>
				<li class="breadcrumb-item" aria-current="page"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)">{{$route.params.vhost}}</router-link></li>
				<li class="breadcrumb-item" aria-current="page"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps'">Apps</router-link></li>
				<li class="breadcrumb-item active" aria-current="page">
					{{$route.params.app}}
					<div class="spinner-border spinner-border-sm" role="status" v-if="loading">
						<span class="visually-hidden">Loading...</span>
					</div>
				</li>
			</ol>
		</nav>
		<div class="alert alert-danger" v-if="error">{{error}}</div>
		<div class="row">
			<div class="col-8">
				<div v-if="app">
					<ul>
						<li>Name: {{app.name}}</li>
						<li>Dynamic: {{app.dynamic}}</li>
						<li>Type: {{app.type}}</li>
						<li v-if="app.transcodeWebhook">
							Transcode webhook
							<ul>
								<li>Control server URL: {{app.transcodeWebhook.controlServerUrl}}</li>
								<li>Enable: {{app.transcodeWebhook.enable}}</li>
								<li>Secret key: ******</li>
								<li>Timeout: {{app.transcodeWebhook.timeout}}</li>
								<li>Use Local Profiles On Connection Failure: {{app.transcodeWebhook.useLocalProfilesOnConnectionFailure}}</li>
								<li>Use Local Profiles On Error Response: {{app.transcodeWebhook.useLocalProfilesOnErrorResponse}}</li>
								<li>Use Local Profiles On Server Disallow: {{app.transcodeWebhook.useLocalProfilesOnServerDisallow}}</li>
							</ul>
						</li>
						<li v-if="app.publishers">
							Publishers
							<ul>
								<li v-if="app.publishers.ovt">OVT</li>
								<li v-if="app.publishers.llhls">LLHLS</li>
								<li v-if="app.publishers.webRtc">WebRTC</li>
							</ul>
						</li>
						<li v-if="app.providers">
							Providers
							<ul>
								<li v-if="app.providers.rtmp">RTMP</li>
								<li v-if="app.providers.webRtc">WebRTC</li>
								<li v-if="app.providers.srt">SRT</li>
								<li v-if="app.providers.rstpPull">RTSPPull</li>
								<li v-if="app.providers.ovt">OVT</li>
								<li v-if="app.providers.mpegts">MPEGTS</li>
							</ul>
						</li>
						<li><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)+'/pushes'">Pushes</router-link></li>
						<li><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)+'/streams'">Streams</router-link></li>
						<li><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)+'/outputProfiles'">Output profiles</router-link>: <span v-for="(p, idx) in app?.outputProfiles?.outputProfile"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)+'/outputProfiles/'+encodeURIComponent(p.name)">{{p.name}}</router-link></span></li>
					</ul>
				</div>
			</div>
			<div class="col-4">
				<statistics :data="statistics"/>
			</div>
		</div>
	`,
	data() { return {
		error: null,
		loading: 0,
		app: null,
		statistics: null,
	}},
	components: {
		Statistics,
	},
	created() {
		const server = JSON.parse(localStorage.getItem('hosts')||'[]').find(s => s.url == this.$route.params.serverUrl);
		api.setApiUrl(server.url);
		api.setAccessToken(server.token);
		this.loadApp();
	},
	methods: {
		async loadApp() {
			try {
				this.loading++;
				this.app = await api.get(`vhosts/${encodeURIComponent(this.$route.params.vhost)}/apps/${this.$route.params.app}`);
				this.statistics = await api.get(`stats/current/vhosts/${encodeURIComponent(this.$route.params.vhost)}/apps/${this.$route.params.app}`);
			} catch(e) {
				this.error = e;
			} finally {
				this.loading--;
			}
		},
	},
};

const AppOutputProfiles = {
	template: `
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><router-link to="/">Servers</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)">{{$route.params.serverUrl}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts'">vhosts</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)">{{$route.params.vhost}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps'">Apps</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)">{{$route.params.app}}</router-link></li>
				<li class="breadcrumb-item active" aria-current="page">
					Output profiles
					<div class="spinner-border spinner-border-sm" role="status" v-if="loading">
						<span class="visually-hidden">Loading...</span>
					</div>
				</li>
			</ol>
		</nav>
		<div class="alert alert-danger" v-if="error">{{error}}</div>
		<div v-if="outputProfiles && outputProfiles.length > 0">
			<table class="table table-sm">
				<thead><tr><th>Name</th></tr></thead>
				<tbody>
					<tr v-for="(p, idx) in outputProfiles">
						<td><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)+'/outputProfiles/'+encodeURIComponent(p)">{{p}}</router-link></td>
					</tr>
				</tbody>
			</table>
		</div>
		<div v-else>No data</div>
	`,
	data() { return {
		error: null,
		loading: 0,
		outputProfiles: [],
	}},
	created() {
		const server = JSON.parse(localStorage.getItem('hosts')||'[]').find(s => s.url == this.$route.params.serverUrl);
		api.setApiUrl(server.url);
		api.setAccessToken(server.token);
		this.loadOutputProfiles();
	},
	methods: {
		loadOutputProfiles() {
			this.loading++;
			api.get(`vhosts/${encodeURIComponent(this.$route.params.vhost)}/apps/${this.$route.params.app}/outputProfiles`).then(outputProfiles => this.outputProfiles = outputProfiles, err => this.error = err).finally(() => this.loading--);
		},
	},
};

const AppOutputProfile = {
	template: `
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><router-link to="/">Servers</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)">{{$route.params.serverUrl}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts'">vhosts</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)">{{$route.params.vhost}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps'">Apps</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)">{{$route.params.app}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)+'/outputProfiles'">Output profiles</router-link></li>
				<li class="breadcrumb-item active" aria-current="page">
					{{$route.params.outputProfile}}
					<div class="spinner-border spinner-border-sm" role="status" v-if="loading">
						<span class="visually-hidden">Loading...</span>
					</div>
				</li>
			</ol>
		</nav>
		<div class="alert alert-danger" v-if="error">{{error}}</div>
		<div v-if="outputProfile">
			Audios:
			<table class="table table-sm table-striped" v-if="outputProfile.encodes && outputProfile.encodes.audios">
				<thead>
					<tr><th>Name</th><th>Bypass</th><th>Bitrate</th><th>Channels</th><th>Codec</th><th>Sample rate</th></tr>
				</thead>
				<tbody>
					<tr v-for="(a, idx) in outputProfile.encodes.audios" :key="idx">
						<td>{{a.name}}</td>
						<td>{{a.bypass ? '☑' : '☐'}} <code v-if="a.bypassIfMatch">{{a.bypassIfMatch}}</code></td>
						<td>{{a.bitrate}}</td>
						<td>{{a.channel}}</td>
						<td>{{a.codec}}</td>
						<td>{{a.samplerate}}</td>
					</tr>
				</tbody>
			</table>
			Videos:
			<table class="table table-sm table-striped" v-if="outputProfile.encodes && outputProfile.encodes.videos">
				<thead>
					<tr><th>Name</th><th>Bypass</th><th>Bitrate</th><th>Channels</th><th>Codec</th><th>Frame rate</th></tr>
				</thead>
				<tbody>
					<tr v-for="(a, idx) in outputProfile.encodes.videos" :key="idx">
						<td>{{a.name}}</td>
						<td>{{a.bypass ? '☑' : '☐'}} <code v-if="a.bypassIfMatch">{{a.bypassIfMatch}}</code></td>
						<td>{{a.bitrate}}</td>
						<td>{{a.channel}}</td>
						<td>{{a.codec}}</td>
						<td>{{a.framerate}}</td>
					</tr>
				</tbody>
			</table>
		</div>
		<div v-else>No data</div>
	`,
	data() { return {
		error: null,
		loading: 0,
		outputProfile: [],
	}},
	created() {
		const server = JSON.parse(localStorage.getItem('hosts')||'[]').find(s => s.url == this.$route.params.serverUrl);
		api.setApiUrl(server.url);
		api.setAccessToken(server.token);
		this.loadOutputProfile();
	},
	methods: {
		loadOutputProfile() {
			this.loading++;
			api.get(`vhosts/${encodeURIComponent(this.$route.params.vhost)}/apps/${this.$route.params.app}/outputProfiles/${this.$route.params.outputProfile}`).then(outputProfile => this.outputProfile = outputProfile, err => this.error = err).finally(() => this.loading--);
		},
	},
};

const AppPushes = {
	template: `
		<nav aria-label="breadcrumb">
			<div class="float-end">
				<div class="float-end">
					<div class="form-check form-switch form-check-reverse">
						<input class="form-check-input" type="checkbox" id="autoRefresh" v-model="autoRefresh">
						<label class="form-check-label" for="autoRefresh">auto refresh</label>
					</div>
				</div>
			</div>
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><router-link to="/">Servers</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)">{{$route.params.serverUrl}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts'">vhosts</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)">{{$route.params.vhost}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps'">Apps</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)">{{$route.params.app}}</router-link></li>
				<li class="breadcrumb-item active" aria-current="page">
					Pushes
					<div class="spinner-border spinner-border-sm" role="status" v-if="loading">
						<span class="visually-hidden">Loading...</span>
					</div>
					<a v-else href="#" @click.prevent="loadPushes()">&#128472;</a>
				</li>
			</ol>
		</nav>
		<div class="row">
			<div class="col-8">
				<div class="alert alert-danger" v-if="error">{{error}}</div>
				<div v-if="pushes">
					<table class="table table-sm">
						<thead><tr><th>URL</th><th>Sent</th><th></th></tr></thead>
						<tbody>
							<tr v-for="(p, idx) in pushes">
								<td>{{p.id}}<br />{{p.state}} {{p.protocol}}<br />{{p.url}}<br /><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)+'/streams/'+encodeURIComponent(p.stream.name)">{{p.stream.name}}</router-link></td>
								<td>
									<code>{{prettyBytes(p.sentBytes)}}/{{readableTime(p.sentTime)}} sent</code><br />
									<code>{{prettyBytes(p.totalsentBytes)}}/{{readableTime(p.totalsentTime)}} total</code><br />
									<code>{{prettyBytes(p.totalsentBytes/p.totalsentTime*1000)}}/s average</code>
								</td>
								<td class="text-end"><a href="#" @click.prevent="stopPush(p.id)" class="text-danger">Stop</a></td>
							</tr>
						</tbody>
					</table>
				</div>
				<div v-else>No pushes</div>
			</div>
			<div class="col-4">
				<form action="" @submit.prevent.stop="startPush()">
					<div class="form-group mb-3">
						<label for="pushId">ID</label>
						<input type="text" class="form-control" v-model="push.id" id="pushId">
					</div>
					<div class="form-group mb-3">
						<label for="pushStreamName">Stream</label>
						<select class="form-select" v-model="push.streamName" id="pushStreamName">
							<option v-for="(p, idx) in outputProfiles" :key="idx" :value="p">{{p}}</option>
						</select>
					</div>
					<div class="form-group mb-3" v-if="outputProfile">
						<div class="form-check form-check-inline" v-for="(v, idx) in outputProfile.encodes.audios" :key="idx">
							<input class="form-check-input" type="checkbox" :value="v.name" :id="'pushStreamAudioVariant_'+v.name">
							<label class="form-check-label" :for="'pushStreamAudioVariant_'+v.name">{{v.name}}</label>
						</div>
						<div class="form-check form-check-inline" v-for="(v, idx) in outputProfile.encodes.videos" :key="idx">
							<input class="form-check-input" type="checkbox" :value="v.name" :id="'pushStreamAudioVariant_'+v.name">
							<label class="form-check-label" :for="'pushStreamAudioVariant_'+v.name">{{v.name}}</label>
						</div>
					</div>
					<div class="form-group mb-3">
						<label for="pushUrl">URL</label>
						<input type="text" class="form-control" v-model="push.url" id="pushUrl">
					</div>
					<div class="form-group mb-3">
						<label for="pushProtocol">Protocol</label><br />
						<div class="form-check form-check-inline">
							<input class="form-check-input" type="radio" id="pushProtocolRtmp" value="rtmp" v-model="push.protocol">
							<label class="form-check-label" for="pushProtocolRtmp">RTMP</label>
						</div>
						<div class="form-check form-check-inline">
							<input class="form-check-input" type="radio" id="pushProtocolSrt" value="srt" v-model="push.protocol">
							<label class="form-check-label" for="pushProtocolSrt">SRT</label>
						</div>
					</div>
					<div class="form-group mb-3">
						<label for="pushStreamKey">Stream key</label>
						<input type="text" class="form-control" v-model="push.streamKey" id="pushStreamKey">
					</div>
					<label>&nbsp;</label><br />
					<button type="submit" class="btn btn-primary">Start push</button>
				</form>
			</div>
		</div>
	`,
	data() { return {
		loading: 0,
		error: null,
		autoRefresh: false,
		pushes: [],
		outputProfiles: [],
		outputProfile: null,
		push: {
			protocol: 'rmtp',
			streamKey: '',
			id: '',
			streamName: '',
			url: 'rtmp://',
		},
	}},
	async created() {
		const server = JSON.parse(localStorage.getItem('hosts')||'[]').find(s => s.url == this.$route.params.serverUrl);
		api.setApiUrl(server.url);
		api.setAccessToken(server.token);
		await this.loadPushes();
		await this.loadOutputProfiles();
		this.autoRefresh = true;
	},
	unmounted() {
		if(this.refreshInterval) clearInterval(this.refreshInterval);
	},
	watch: {
		'push.streamName': function(value) { api.get(`vhosts/${encodeURIComponent(this.$route.params.vhost)}/apps/${encodeURIComponent(this.$route.params.app)}/outputProfiles/${encodeURIComponent(value)}`).then(profile => this.outputProfile = profile, err => this.error = err) },
		autoRefresh: function(value) { if(value) this.refreshInterval = setInterval(() => this.loadPushes(), 2000); else if(this.refreshInterval) clearInterval(this.refreshInterval); },
	},
	methods: {
		async loadPushes() {
			try {
				this.loading++;
				this.pushes = await api.post(`vhosts/${encodeURIComponent(this.$route.params.vhost)}/apps/${this.$route.params.app}:pushes`);
			} catch(e) {
				this.error = e;
			} finally {
				this.loading--;
			}
		},
		async loadOutputProfiles() {
			try {
				this.loading++;
				this.outputProfiles = await api.get(`vhosts/${encodeURIComponent(this.$route.params.vhost)}/apps/${this.$route.params.app}/outputProfiles`);
				if(!this.push.streamName && this.outputProfiles.length > 0) this.push.streamName = this.outputProfiles[0];
			} catch(e) {
				this.error = e;
			} finally {
				this.loading--;
			}
		},
		async stopPush(id) {
			try {
				this.loading++;
				await api.post(`vhosts/${encodeURIComponent(this.$route.params.vhost)}/apps/${this.$route.params.app}:stopPush`, { id });
			} catch(e) {
				this.error = e;
			} finally {
				this.loading--;
			}
		},
		startPush() {
			console.log('push', this.push);
		},
		prettyBytes(num) {
			// jacked from: https://github.com/sindresorhus/pretty-bytes
			if (typeof num !== 'number' || isNaN(num)) {
				return '-';
			}

			var exponent;
			var unit;
			var neg = num < 0;
			var units = ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

			if (neg) {
				num = -num;
			}

			if (num < 1) {
				return (neg ? '-' : '') + num + ' B';
			}

			exponent = Math.min(Math.floor(Math.log(num) / Math.log(1000)), units.length - 1);
			num = (num / Math.pow(1000, exponent)).toFixed(2) * 1;
			unit = units[exponent];

			return (neg ? '-' : '') + num + ' ' + unit;
		},
		readableTime(ms) {
			const
				s = Math.floor(ms / 1000),
				seconds = s % 60,
				minutes = Math.floor(s / 60) % 60,
				hours = Math.floor(s / 60 / 60 ) % 60,
				days = Math.floor(s / 60 / 60 / 24);

			return `${days ? `${days}d,` : ''}${days||hours ? `${this.padInt(hours)}:` : ''}${days||hours||minutes ? `${this.padInt(minutes)}:` : ''}${this.padInt(seconds)}`;
		},
		padInt(i) { return i > 10 ? i : `0${i}`; },
	},
};

const AppStreams = {
	template: `
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><router-link to="/">Servers</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)">{{$route.params.serverUrl}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts'">vhosts</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)">{{$route.params.vhost}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps'">Apps</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)">{{$route.params.app}}</router-link></li>
				<li class="breadcrumb-item active" aria-current="page">
					Streams
					<div class="spinner-border spinner-border-sm" role="status" v-if="loading">
						<span class="visually-hidden">Loading...</span>
					</div>
					<a v-else href="#" @click.prevent="loadStreams()">&#128472;</a>
				</li>
			</ol>
		</nav>
		<div class="alert alert-danger" v-if="error">{{error}}</div>
		<div v-if="streams && streams.length > 0">
			<div class="row">
				<div class="col-8">
					<table class="table table-sm">
						<thead><tr><th>Stream ID</th></tr></thead>
						<tbody>
							<tr v-for="(p, idx) in streams">
								<td><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)+'/streams/'+encodeURIComponent(p)">{{p}}</router-link></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<div v-else-if="loading==0">No streams</div>
	`,
	data() { return {
		error: null,
		loading: 0,
		streams: [],
	}},
	created() {
		const server = JSON.parse(localStorage.getItem('hosts')||'[]').find(s => s.url == this.$route.params.serverUrl);
		api.setApiUrl(server.url);
		api.setAccessToken(server.token);
		this.loadStreams();
	},
	methods: {
		async loadStreams() {
			try {
				this.loading++;
				this.streams = await api.get(`vhosts/${encodeURIComponent(this.$route.params.vhost)}/apps/${this.$route.params.app}/streams`);
			} catch(e) {
				this.error = e;
			} finally {
				this.loading--;
			}
		},
	},
};

const AppStream = {
	template: `
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><router-link to="/">Servers</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)">{{$route.params.serverUrl}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts'">vhosts</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)">{{$route.params.vhost}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps'">Apps</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)">{{$route.params.app}}</router-link></li>
				<li class="breadcrumb-item"><router-link :to="'/'+encodeURIComponent($route.params.serverUrl)+'/vhosts/'+encodeURIComponent($route.params.vhost)+'/apps/'+encodeURIComponent($route.params.app)+'/streams'">Streams</router-link></li>
				<li class="breadcrumb-item active" aria-current="page">
					{{$route.params.stream}}
					<div class="spinner-border spinner-border-sm" role="status" v-if="loading">
						<span class="visually-hidden">Loading...</span>
					</div>
				</li>
			</ol>
		</nav>
		<div class="alert alert-danger" v-if="error">{{error}}</div>
		<div v-if="stream">
			<div class="row">
				<div class="col-8">
					<div class="float-end">
						<div class="form-check form-switch form-check-reverse">
							<input class="form-check-input" type="checkbox" id="showStreamJson" v-model="showStreamJson">
							<label class="form-check-label" for="showStreamJson">raw</label>
						</div>
					</div>
					<h3>Stream</h3>
					<pre v-show="showStreamJson">{{stream}}</pre>
					<div v-show="!showStreamJson">
						<ul>
							<li>Created <abbr :title="stream.input.createdTime">{{fromNow(stream.input.createdTime)}}</abbr></li>
							<li>Source: {{stream.input.sourceType}} from {{stream.input.sourceUrl}}</li>
							<li>Name: {{stream.name}}</li>
						</ul>
						<h3>Input tracks</h3>
						<table class="table table-sm">
							<thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Details</th></tr></thead>
							<tbody>
								<tr v-for="(t, idx) in stream.input.tracks" :key="idx">
									<td>{{t.id}}</td>
									<td>{{t.name}}</td>
									<td>{{t.type}}</td>
									<td>
										<ul v-if="t.video">
											<li>{{t.video.width}}x{{t.video.height}}@{{t.video.framerate}}fps</li>
											<li>bitrate: {{t.video.bitrate}}</li>
											<li>bypass: {{t.video.bypass}}</li>
											<li>codec: {{t.video.codec}}</li>
											<li>hasBframes: {{t.video.hasBframes}}</li>
											<li>keyFrameInterval: {{t.video.keyFrameInterval}} ({{(t.video.keyFrameInterval/t.video.framerate).toFixed(2)}}s)</li>
										</ul>
										<ul v-else-if="t.audio">
											<li>bitrate: {{t.audio.bitrate}}</li>
											<li>bypass: {{t.audio.bypass}}</li>
											<li>channel: {{t.audio.channel}}</li>
											<li>codec: {{t.audio.codec}}</li>
											<li>samplerate: {{t.audio.samplerate}}</li>
										</ul>
									</td>
								</tr>
							</tbody>
						</table>
						<div v-for="(o, idx) in stream.outputs">
							<h3>Output {{o.name}}</h3>
							<table class="table table-sm">
								<thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Details</th></tr></thead>
								<tbody>
									<tr v-for="(t, idx2) in o.tracks" :key="idx2">
										<td>{{t.id}}</td>
										<td>{{t.name}}</td>
										<td>{{t.type}}</td>
										<td>
											<ul v-if="t.video">
												<li>bypass: {{t.video.bypass}}</li>
												<li>{{t.video}}</li>
											</ul>
											<ul v-else-if="t.audio">
												<li>bypass: {{t.audio.bypass}}</li>
												<li>{{t.audio}}</li>
											</ul>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<div class="col-4">
					<statistics :data="statistics"/>
				</div>
			</div>
		</div>
		<div v-else>No data</div>
	`,
	data() { return {
		error: null,
		loading: 0,
		stream: null,
		statistics: null,
		showStreamJson: false,
	}},
	components: {
		Statistics,
	},
	created() {
		const server = JSON.parse(localStorage.getItem('hosts')||'[]').find(s => s.url == this.$route.params.serverUrl);
		api.setApiUrl(server.url);
		api.setAccessToken(server.token);
		this.loadStream();
	},
	filters: {
		fromNow(d) { return moment(d).fromNow(); },
		formatBytes(b) { return formatBytes(b); },
	},
	methods: {
		async loadStream() {
			try {
				this.loading++;
				this.stream = await api.get(`vhosts/${encodeURIComponent(this.$route.params.vhost)}/apps/${this.$route.params.app}/streams/${this.$route.params.stream}`);
				this.statistics = await api.get(`stats/current/vhosts/${encodeURIComponent(this.$route.params.vhost)}/apps/${this.$route.params.app}/streams/${this.$route.params.stream}`);
			} catch(e) {
				this.error = e;
			} finally {
				this.loading--;
			}
		},
		fromNow(d) { return moment(d).fromNow(); },
		formatBytes(d) { return formatBytes(d); },
	},
};

const router = VueRouter.createRouter({
	history: VueRouter.createWebHashHistory(),
	routes: [
		{ path: '/', component: Home },
		{ path: '/:serverUrl', component: Server },
		{ path: '/:serverUrl/vhosts', component: VHosts },
		{ path: '/:serverUrl/vhosts/:vhost', component: VHost },
		{ path: '/:serverUrl/vhosts/:vhost/apps', component: Apps },
		{ path: '/:serverUrl/vhosts/:vhost/apps/:app', component: App },
		{ path: '/:serverUrl/vhosts/:vhost/apps/:app/outputProfiles', component: AppOutputProfiles },
		{ path: '/:serverUrl/vhosts/:vhost/apps/:app/outputProfiles/:outputProfile', component: AppOutputProfile },
		{ path: '/:serverUrl/vhosts/:vhost/apps/:app/pushes', component: AppPushes },
		{ path: '/:serverUrl/vhosts/:vhost/apps/:app/streams', component: AppStreams },
		{ path: '/:serverUrl/vhosts/:vhost/apps/:app/streams/:stream', component: AppStream },
	]
});
const app = Vue.createApp({
})

app.use(router);

app.mount('#app');
		</script>
	</body>
</html>
